<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator Test - Debug Mode</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-panel {
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
        }
        .error-panel {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .calculator-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="text-center mb-4">
            <h1 class="display-4 fw-bold text-primary">üîß Calculator Debug Test</h1>
            <p class="lead">This version will show us exactly what's happening</p>
        </div>

        <!-- Debug Status Panel -->
        <div class="debug-panel">
            <h5>üîç Debug Status</h5>
            <div id="debugStatus">Loading...</div>
        </div>

        <!-- Error Panel -->
        <div class="error-panel" id="errorPanel" style="display: none;">
            <h5>‚ùå Errors Detected</h5>
            <div id="errorContent"></div>
        </div>

        <div class="calculator-section">
            <div class="row">
                <div class="col-lg-6">
                    <!-- Square Footage Slider -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">üè¢ Facility Size (Square Feet)</label>
                        <input type="range" class="form-range" id="squareFootage" 
                               min="500" max="50000" value="3500" step="250">
                        <div class="d-flex justify-content-between">
                            <small>500 sq ft</small>
                            <strong id="sqftDisplay">3,500 sq ft</strong>
                            <small>50,000+ sq ft</small>
                        </div>
                    </div>

                    <!-- Service Type -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">üèóÔ∏è Service Type</label>
                        <select class="form-select" id="serviceType">
                            <option value="commercial">üè¢ Commercial Facility</option>
                            <option value="residential">üè† Residential Property</option>
                            <option value="healthcare">üè• Healthcare Facility</option>
                        </select>
                    </div>

                    <!-- Test Buttons -->
                    <div class="mb-4">
                        <button class="btn btn-primary me-2" onclick="testCalculator()">üß™ Test Calculator</button>
                        <button class="btn btn-secondary me-2" onclick="testElements()">üîç Test Elements</button>
                        <button class="btn btn-warning" onclick="clearDebug()">üóëÔ∏è Clear Log</button>
                    </div>
                </div>

                <div class="col-lg-6">
                    <!-- Results Display -->
                    <div class="bg-primary text-white p-4 rounded">
                        <h3 class="fw-bold mb-3">üí∞ Price Display Test</h3>
                        <div class="display-4 fw-bold mb-2" id="totalPrice">$620</div>
                        <p class="fs-5 mb-3" id="priceFrequency">per service</p>
                        
                        <!-- Simple breakdown -->
                        <div class="bg-light bg-opacity-25 p-3 rounded">
                            <h5 class="fw-bold mb-2">üìã Test Values</h5>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Square Feet:</span>
                                <span id="testSqft">3,500</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Service Type:</span>
                                <span id="testServiceType">commercial</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Base Rate:</span>
                                <span id="testBaseRate">$0.125</span>
                            </div>
                            <div class="d-flex justify-content-between fw-bold">
                                <span>Calculated Price:</span>
                                <span id="testCalculatedPrice">$437.50</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global debug log
        let debugLog = [];
        let errorCount = 0;

        // Enhanced logging
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            
            debugLog.push(logEntry);
            console.log(logEntry);
            
            if (type === 'error') {
                errorCount++;
                showError(message);
            }
            
            updateDebugDisplay();
        }

        function showError(message) {
            const errorPanel = document.getElementById('errorPanel');
            const errorContent = document.getElementById('errorContent');
            
            if (errorPanel && errorContent) {
                errorPanel.style.display = 'block';
                errorContent.innerHTML += `<div class="mb-2">‚ùå ${message}</div>`;
            }
        }

        function updateDebugDisplay() {
            const debugStatus = document.getElementById('debugStatus');
            if (debugStatus) {
                const recent = debugLog.slice(-10); // Show last 10 entries
                debugStatus.innerHTML = recent.join('<br>');
            }
        }

        function clearDebug() {
            debugLog = [];
            errorCount = 0;
            const errorPanel = document.getElementById('errorPanel');
            const errorContent = document.getElementById('errorContent');
            
            if (errorPanel) errorPanel.style.display = 'none';
            if (errorContent) errorContent.innerHTML = '';
            
            updateDebugDisplay();
            addLog('Debug log cleared');
        }

        // Simple pricing rules for testing
        const testPricingRules = {
            baseRates: {
                commercial: 0.125,
                residential: 0.15,
                healthcare: 0.14
            },
            minimums: {
                commercial: 450,
                residential: 200,
                healthcare: 500
            }
        };

        function testElements() {
            addLog('Starting element test...');
            
            const elements = [
                'squareFootage',
                'serviceType', 
                'totalPrice',
                'priceFrequency',
                'sqftDisplay',
                'testSqft',
                'testServiceType',
                'testBaseRate',
                'testCalculatedPrice'
            ];

            let foundElements = 0;
            let missingElements = [];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    foundElements++;
                    addLog(`‚úÖ Found element: ${id} (${element.tagName})`);
                } else {
                    missingElements.push(id);
                    addLog(`‚ùå Missing element: ${id}`, 'error');
                }
            });

            addLog(`Element test complete: ${foundElements}/${elements.length} found`);
            
            if (missingElements.length > 0) {
                addLog(`Missing elements: ${missingElements.join(', ')}`, 'error');
            }

            return foundElements === elements.length;
        }

        function testCalculator() {
            addLog('Starting calculator test...');
            
            try {
                // Test element access
                const sqftElement = document.getElementById('squareFootage');
                const serviceTypeElement = document.getElementById('serviceType');
                
                if (!sqftElement) {
                    throw new Error('squareFootage element not found');
                }
                if (!serviceTypeElement) {
                    throw new Error('serviceType element not found');
                }

                // Get values
                const sqft = parseInt(sqftElement.value);
                const serviceType = serviceTypeElement.value;
                
                addLog(`Input values: sqft=${sqft}, serviceType=${serviceType}`);
                
                // Simple calculation
                const baseRate = testPricingRules.baseRates[serviceType];
                const minimum = testPricingRules.minimums[serviceType];
                
                addLog(`Base rate: ${baseRate}, Minimum: ${minimum}`);
                
                let price = sqft * baseRate;
                price = Math.max(price, minimum);
                
                addLog(`Calculated price: ${price}`);
                
                // Update displays
                updateTestDisplays(sqft, serviceType, baseRate, price);
                
                addLog('‚úÖ Calculator test completed successfully');
                
            } catch (error) {
                addLog(`Calculator test failed: ${error.message}`, 'error');
                throw error;
            }
        }

        function updateTestDisplays(sqft, serviceType, baseRate, price) {
            try {
                const updates = {
                    'sqftDisplay': sqft.toLocaleString() + ' sq ft',
                    'totalPrice': '$' + Math.round(price).toLocaleString(),
                    'testSqft': sqft.toLocaleString(),
                    'testServiceType': serviceType,
                    'testBaseRate': '$' + baseRate,
                    'testCalculatedPrice': '$' + Math.round(price).toLocaleString()
                };

                for (const [id, value] of Object.entries(updates)) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                        addLog(`Updated ${id}: ${value}`);
                    } else {
                        addLog(`Failed to update ${id}: element not found`, 'error');
                    }
                }
            } catch (error) {
                addLog(`Update displays failed: ${error.message}`, 'error');
            }
        }

        // Event handler for slider
        function handleSliderChange() {
            addLog('Slider changed - running calculator test');
            testCalculator();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            addLog('DOM Content Loaded - Starting initialization');
            
            // Test elements first
            const elementsOK = testElements();
            
            if (elementsOK) {
                addLog('All elements found - setting up event listeners');
                
                // Add event listeners
                const slider = document.getElementById('squareFootage');
                const serviceSelect = document.getElementById('serviceType');
                
                if (slider) {
                    slider.addEventListener('input', handleSliderChange);
                    slider.addEventListener('change', handleSliderChange);
                    addLog('‚úÖ Slider event listeners added');
                }
                
                if (serviceSelect) {
                    serviceSelect.addEventListener('change', handleSliderChange);
                    addLog('‚úÖ Service select event listener added');
                }
                
                // Run initial test
                testCalculator();
                
            } else {
                addLog('‚ùå Missing elements - cannot initialize properly', 'error');
            }
        });

        // Global error handler
        window.addEventListener('error', function(event) {
            addLog(`Global error: ${event.error ? event.error.message : event.message}`, 'error');
        });

        // Initial log
        addLog('Calculator debug script loaded');
    </script>
</body>
</html>
