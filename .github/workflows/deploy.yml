# ================================================================
# ORGANIC HYPOSOLUTIONS - SIMPLIFIED DEPLOYMENT WORKFLOW
# ================================================================
# Fixed: Node version, caching issues, and over-complex validation
# Purpose: Deploy static site to GitHub Pages (simple and reliable)
# ================================================================

name: Deploy OHS Website

on:
  push:
    branches: [ main ]

# Permissions for GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Prevent concurrent deployments
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ================================================================
  # BUILD AND DEPLOY TO GITHUB PAGES
  # ================================================================
  deploy:
    name: Build & Deploy to GitHub Pages
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    # ----------------------------------------
    # Checkout Repository
    # ----------------------------------------
    - name: ğŸ” Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------
    # Setup Node.js (Fixed Version)
    # ----------------------------------------
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        # Removed problematic caching

    # ----------------------------------------
    # Install Dependencies (Only if package.json exists)
    # ----------------------------------------
    - name: ğŸ“¦ Install Dependencies
      run: |
        if [ -f package.json ]; then
          echo "ğŸ“¦ Installing dependencies..."
          npm install
        else
          echo "ğŸ“ No package.json found - skipping dependencies"
        fi

    # ----------------------------------------
    # Basic Validation
    # ----------------------------------------
    - name: ğŸ” Basic Validation
      run: |
        echo "ğŸ” Checking basic files..."
        
        # Check if critical files exist
        if [ ! -f "index.html" ]; then
          echo "âŒ index.html not found!"
          exit 1
        fi
        
        echo "âœ… Basic validation passed"

    # ----------------------------------------
    # Prepare Static Site
    # ----------------------------------------
    - name: ğŸ“ Prepare Static Site
      run: |
        echo "ğŸ“ Preparing static site..."
        
        # Create build directory
        mkdir -p _site
        
        # Copy all necessary files
        cp -r * _site/ 2>/dev/null || true
        
        # Remove unnecessary files from build
        rm -rf _site/node_modules _site/.git _site/_site _site/.github 2>/dev/null || true
        
        # Ensure index.html exists in build
        if [ ! -f "_site/index.html" ]; then
          echo "âŒ index.html missing from build!"
          exit 1
        fi
        
        echo "âœ… Static site prepared"

    # ----------------------------------------
    # Setup GitHub Pages
    # ----------------------------------------
    - name: ğŸ”§ Setup Pages
      uses: actions/configure-pages@v4

    # ----------------------------------------
    # Upload to GitHub Pages
    # ----------------------------------------
    - name: ğŸ“¤ Upload to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

    # ----------------------------------------
    # Deploy to GitHub Pages
    # ----------------------------------------
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    # ----------------------------------------
    # Success Summary
    # ----------------------------------------
    - name: âœ… Deployment Summary
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ Your site is available at: ${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "Next steps:"
        echo "1. ğŸ”Œ Deploy API functions to Vercel separately"
        echo "2. ğŸ”§ Set up environment variables in Vercel"
        echo "3. ğŸ§ª Test your live site"
